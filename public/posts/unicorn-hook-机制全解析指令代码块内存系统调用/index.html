<!doctype html>
<html lang="zh-cn">
  <head>
    <title>Unicorn Hook æœºåˆ¶å…¨è§£æï¼šæŒ‡ä»¤ã€ä»£ç å—ã€å†…å­˜ã€ç³»ç»Ÿè°ƒç”¨ // CYRUS STUDIO</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.131.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <meta name="keywords" content="CYRUS STUDIO, å®‰å“é€†å‘, Android Reverse Engineering, ç§»åŠ¨å¼€å‘, å®‰å“å¼€å‘, Python">
    <meta name="robots" content="index, follow">
    <link rel="stylesheet" href="/blog/css/main.min.d970c1dc93ec518baa03345e73aafb7a5a0879e5830ca966a23c6d3552430ab1.css" />
    

    
  


    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Unicorn Hook æœºåˆ¶å…¨è§£æï¼šæŒ‡ä»¤ã€ä»£ç å—ã€å†…å­˜ã€ç³»ç»Ÿè°ƒç”¨">
  <meta name="twitter:description" content="ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œå¦‚æœ‰è½¬å‘ï¼Œè¯·æ³¨æ˜æ–‡ç« å‡ºå¤„ï¼šhttps://cyrus-studio.github.io/blog/
Hook ä¸»è¦ç±»å‹ åœ¨ Unicorn ä¸­ï¼ŒHookï¼ˆé’©å­ï¼‰ç”¨äºåœ¨æ¨¡æ‹Ÿè¿‡ç¨‹ä¸­æ‹¦æˆª CPU æŒ‡ä»¤æ‰§è¡Œã€å†…å­˜è®¿é—®ç­‰æ“ä½œï¼Œä»¥ä¾¿åˆ†æå’Œä¿®æ”¹æ‰§è¡Œè¡Œä¸ºã€‚
Unicorn æä¾›äº†å¤šç§ Hook ç±»å‹ï¼Œæ¯ç§ç±»å‹ç”¨äºä¸åŒåœºæ™¯ï¼š
Hook ç±»å‹ è¯´æ˜ ç¤ºä¾‹ UC_HOOK_CODE æ‹¦æˆªæ¯ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œ ç›‘æ§æŒ‡ä»¤æµï¼Œåè°ƒè¯• UC_HOOK_BLOCK æ‹¦æˆªæ¯ä¸ªåŸºæœ¬å—æ‰§è¡Œ ç»Ÿè®¡åŸºæœ¬å—æ‰§è¡Œæ¬¡æ•° UC_HOOK_INTR æ‹¦æˆªä¸­æ–­æŒ‡ä»¤ï¼ˆå¦‚ svc #0ï¼‰ ç›‘æ§ç³»ç»Ÿè°ƒç”¨ UC_HOOK_MEM_READ è¯»å–å†…å­˜å‰è§¦å‘ ç›‘è§†å˜é‡è¯»å– UC_HOOK_MEM_WRITE å†™å…¥å†…å­˜å‰è§¦å‘ ç›‘è§†å˜é‡ä¿®æ”¹ UC_HOOK_MEM_FETCH å–æŒ‡ä»¤å‰è§¦å‘ æ•è·æœªæ˜ å°„ä»£ç æ‰§è¡Œ UC_HOOK_MEM_READ_UNMAPPED è¯»å–æœªæ˜ å°„å†…å­˜ æ•è·éæ³•å†…å­˜è¯»å– UC_HOOK_MEM_WRITE_UNMAPPED å†™å…¥æœªæ˜ å°„å†…å­˜ æ•è·éæ³•å†…å­˜å†™å…¥ UC_HOOK_MEM_FETCH_UNMAPPED å–æŒ‡æœªæ˜ å°„å†…å­˜ æ•è·éæ³•æŒ‡ä»¤æ‰§è¡Œ UC_HOOK_INSN æ‹¦æˆªç‰¹å®šæŒ‡ä»¤ ç›‘æ§ syscallã€hlt ç­‰ Hook æŒ‡ä»¤æ‰§è¡Œ (UC_HOOK_CODE) ç”¨é€” ï¼š
ç›‘æ§æ‰€æœ‰æ‰§è¡Œçš„æŒ‡ä»¤
è®°å½•å¯„å­˜å™¨å˜åŒ–
åè°ƒè¯•
ç¤ºä¾‹ä»£ç 
from unicorn import *from unicorn.arm64_const import *# Hook å›è°ƒå‡½æ•°def hook_code(mu, address, size, user_data):print(f&#34;Executing instruction at 0x{address:X}, size={size}&#34;)# åˆå§‹åŒ– Unicorn ARM64mu = Uc(UC_ARCH_ARM64, UC_MODE_ARM)# åˆ†é…å†…å­˜BASE = 0x1000mu.">

    <meta property="og:url" content="https://cyrus-studio.github.io/blog/posts/unicorn-hook-%E6%9C%BA%E5%88%B6%E5%85%A8%E8%A7%A3%E6%9E%90%E6%8C%87%E4%BB%A4%E4%BB%A3%E7%A0%81%E5%9D%97%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/">
  <meta property="og:site_name" content="CYRUS STUDIO">
  <meta property="og:title" content="Unicorn Hook æœºåˆ¶å…¨è§£æï¼šæŒ‡ä»¤ã€ä»£ç å—ã€å†…å­˜ã€ç³»ç»Ÿè°ƒç”¨">
  <meta property="og:description" content="ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œå¦‚æœ‰è½¬å‘ï¼Œè¯·æ³¨æ˜æ–‡ç« å‡ºå¤„ï¼šhttps://cyrus-studio.github.io/blog/
Hook ä¸»è¦ç±»å‹ åœ¨ Unicorn ä¸­ï¼ŒHookï¼ˆé’©å­ï¼‰ç”¨äºåœ¨æ¨¡æ‹Ÿè¿‡ç¨‹ä¸­æ‹¦æˆª CPU æŒ‡ä»¤æ‰§è¡Œã€å†…å­˜è®¿é—®ç­‰æ“ä½œï¼Œä»¥ä¾¿åˆ†æå’Œä¿®æ”¹æ‰§è¡Œè¡Œä¸ºã€‚
Unicorn æä¾›äº†å¤šç§ Hook ç±»å‹ï¼Œæ¯ç§ç±»å‹ç”¨äºä¸åŒåœºæ™¯ï¼š
Hook ç±»å‹ è¯´æ˜ ç¤ºä¾‹ UC_HOOK_CODE æ‹¦æˆªæ¯ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œ ç›‘æ§æŒ‡ä»¤æµï¼Œåè°ƒè¯• UC_HOOK_BLOCK æ‹¦æˆªæ¯ä¸ªåŸºæœ¬å—æ‰§è¡Œ ç»Ÿè®¡åŸºæœ¬å—æ‰§è¡Œæ¬¡æ•° UC_HOOK_INTR æ‹¦æˆªä¸­æ–­æŒ‡ä»¤ï¼ˆå¦‚ svc #0ï¼‰ ç›‘æ§ç³»ç»Ÿè°ƒç”¨ UC_HOOK_MEM_READ è¯»å–å†…å­˜å‰è§¦å‘ ç›‘è§†å˜é‡è¯»å– UC_HOOK_MEM_WRITE å†™å…¥å†…å­˜å‰è§¦å‘ ç›‘è§†å˜é‡ä¿®æ”¹ UC_HOOK_MEM_FETCH å–æŒ‡ä»¤å‰è§¦å‘ æ•è·æœªæ˜ å°„ä»£ç æ‰§è¡Œ UC_HOOK_MEM_READ_UNMAPPED è¯»å–æœªæ˜ å°„å†…å­˜ æ•è·éæ³•å†…å­˜è¯»å– UC_HOOK_MEM_WRITE_UNMAPPED å†™å…¥æœªæ˜ å°„å†…å­˜ æ•è·éæ³•å†…å­˜å†™å…¥ UC_HOOK_MEM_FETCH_UNMAPPED å–æŒ‡æœªæ˜ å°„å†…å­˜ æ•è·éæ³•æŒ‡ä»¤æ‰§è¡Œ UC_HOOK_INSN æ‹¦æˆªç‰¹å®šæŒ‡ä»¤ ç›‘æ§ syscallã€hlt ç­‰ Hook æŒ‡ä»¤æ‰§è¡Œ (UC_HOOK_CODE) ç”¨é€” ï¼š
ç›‘æ§æ‰€æœ‰æ‰§è¡Œçš„æŒ‡ä»¤
è®°å½•å¯„å­˜å™¨å˜åŒ–
åè°ƒè¯•
ç¤ºä¾‹ä»£ç 
from unicorn import *from unicorn.arm64_const import *# Hook å›è°ƒå‡½æ•°def hook_code(mu, address, size, user_data):print(f&#34;Executing instruction at 0x{address:X}, size={size}&#34;)# åˆå§‹åŒ– Unicorn ARM64mu = Uc(UC_ARCH_ARM64, UC_MODE_ARM)# åˆ†é…å†…å­˜BASE = 0x1000mu.">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-07-11T00:41:47+08:00">
    <meta property="article:modified_time" content="2025-07-11T00:41:47+08:00">


  </head>
  <body>
    <header class="app-header">
      <a href="https://cyrus-studio.github.io/blog/"><img class="app-header-avatar" src="/blog/avatar.jpg" alt="John Doe" /></a>
      <span class="app-header-title">CYRUS STUDIO</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/blog/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/blog/about/">About</a>
             - 
          
          <a class="app-header-menu-item" href="https://github.com/CYRUS-STUDIO">GitHub</a>
      </nav>
      <p>å…¬ä¼—å·ï¼šCYRUS STUDIO</p>
      

      <div class="qrcode-container">
          <img src="/blog/gongzhonghao.jpg" alt="å…¬ä¼—å·äºŒç»´ç " class="qrcode-image">
          <p class="qrcode-text">æ‰«ç å…³æ³¨å…¬ä¼—å·</p>
      </div>

      <div class="visitor-counter">               
        
        <div id="pageview-wrapper" style="display: none; margin-top: 1rem; font-size: 0.9rem; color: #888;">
          ğŸ‘€ è®¿é—®æ¬¡æ•°ï¼š<span class="waline-pageview-count" data-path="/">0</span>
        </div>
      </div>

      <script type="module">
        import { pageviewCount } from 'https://unpkg.com/@waline/client@v3/dist/pageview.js';

        
        pageviewCount({
          serverURL: 'https://waline-15wtwfoa7-cyrus-studios-projects.vercel.app',
          path: '/',
          update: true
        });

        
        setTimeout(() => {
          const el = document.querySelector('.waline-pageview-count[data-path="/"]');
          const count = el?.innerText?.trim();
          if (count && count !== '0') {
            document.getElementById('pageview-wrapper').style.display = 'block';
          }
        }, 2000);
      </script>

    </header>
    <main class="app-container">
      
<article class="post">
  <header class="post-header">
    <meta charset="UTF-8"/>
    <h1 class="post-title">Unicorn Hook æœºåˆ¶å…¨è§£æï¼šæŒ‡ä»¤ã€ä»£ç å—ã€å†…å­˜ã€ç³»ç»Ÿè°ƒç”¨</h1>
    <div class="post-meta" style="display: flex; gap: 1em; flex-wrap: wrap; align-items: center;">
      <div>
        <span class="meta-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-eye">
  <title>eye</title>
  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>
</svg>
          é˜…è¯»é‡: <span class="waline-pageview-count" data-path="/blog/posts/unicorn-hook-%E6%9C%BA%E5%88%B6%E5%85%A8%E8%A7%A3%E6%9E%90%E6%8C%87%E4%BB%A4%E4%BB%A3%E7%A0%81%E5%9D%97%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/"></span>
        </span>
      </div>
      <div>
        <span class="meta-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jul 11, 2025
        </span>
      </div>
      <div>
        <span class="meta-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          5 min read
        </span>
      </div>
    </div>

    <link
      rel="stylesheet"
      href="https://unpkg.com/@waline/client@v3/dist/waline.css"
    />

    <link rel="stylesheet" href="/blog/css/waline-custom.css">

  </header>
  <div class="post-content">
    <blockquote>
<p>ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œå¦‚æœ‰è½¬å‘ï¼Œè¯·æ³¨æ˜æ–‡ç« å‡ºå¤„ï¼š<a href="https://cyrus-studio.github.io/blog/">https://cyrus-studio.github.io/blog/</a></p>
</blockquote>
<h1 id="hook-ä¸»è¦ç±»å‹">Hook ä¸»è¦ç±»å‹</h1>
<p>åœ¨ Unicorn ä¸­ï¼ŒHookï¼ˆé’©å­ï¼‰ç”¨äºåœ¨æ¨¡æ‹Ÿè¿‡ç¨‹ä¸­æ‹¦æˆª CPU æŒ‡ä»¤æ‰§è¡Œã€å†…å­˜è®¿é—®ç­‰æ“ä½œï¼Œä»¥ä¾¿åˆ†æå’Œä¿®æ”¹æ‰§è¡Œè¡Œä¸ºã€‚</p>
<p>Unicorn æä¾›äº†å¤šç§ Hook ç±»å‹ï¼Œæ¯ç§ç±»å‹ç”¨äºä¸åŒåœºæ™¯ï¼š</p>
<table>
<thead>
<tr>
<th>Hook ç±»å‹</th>
<th>è¯´æ˜</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>UC_HOOK_CODE</td>
<td>æ‹¦æˆªæ¯ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œ</td>
<td>ç›‘æ§æŒ‡ä»¤æµï¼Œåè°ƒè¯•</td>
</tr>
<tr>
<td>UC_HOOK_BLOCK</td>
<td>æ‹¦æˆªæ¯ä¸ªåŸºæœ¬å—æ‰§è¡Œ</td>
<td>ç»Ÿè®¡åŸºæœ¬å—æ‰§è¡Œæ¬¡æ•°</td>
</tr>
<tr>
<td>UC_HOOK_INTR</td>
<td>æ‹¦æˆªä¸­æ–­æŒ‡ä»¤ï¼ˆå¦‚ svc #0ï¼‰</td>
<td>ç›‘æ§ç³»ç»Ÿè°ƒç”¨</td>
</tr>
<tr>
<td>UC_HOOK_MEM_READ</td>
<td>è¯»å–å†…å­˜å‰è§¦å‘</td>
<td>ç›‘è§†å˜é‡è¯»å–</td>
</tr>
<tr>
<td>UC_HOOK_MEM_WRITE</td>
<td>å†™å…¥å†…å­˜å‰è§¦å‘</td>
<td>ç›‘è§†å˜é‡ä¿®æ”¹</td>
</tr>
<tr>
<td>UC_HOOK_MEM_FETCH</td>
<td>å–æŒ‡ä»¤å‰è§¦å‘</td>
<td>æ•è·æœªæ˜ å°„ä»£ç æ‰§è¡Œ</td>
</tr>
<tr>
<td>UC_HOOK_MEM_READ_UNMAPPED</td>
<td>è¯»å–æœªæ˜ å°„å†…å­˜</td>
<td>æ•è·éæ³•å†…å­˜è¯»å–</td>
</tr>
<tr>
<td>UC_HOOK_MEM_WRITE_UNMAPPED</td>
<td>å†™å…¥æœªæ˜ å°„å†…å­˜</td>
<td>æ•è·éæ³•å†…å­˜å†™å…¥</td>
</tr>
<tr>
<td>UC_HOOK_MEM_FETCH_UNMAPPED</td>
<td>å–æŒ‡æœªæ˜ å°„å†…å­˜</td>
<td>æ•è·éæ³•æŒ‡ä»¤æ‰§è¡Œ</td>
</tr>
<tr>
<td>UC_HOOK_INSN</td>
<td>æ‹¦æˆªç‰¹å®šæŒ‡ä»¤</td>
<td>ç›‘æ§ syscallã€hlt ç­‰</td>
</tr>
</tbody>
</table>
<h1 id="hook-æŒ‡ä»¤æ‰§è¡Œ-uc_hook_code">Hook æŒ‡ä»¤æ‰§è¡Œ (UC_HOOK_CODE)</h1>
<p><strong>ç”¨é€”</strong> ï¼š</p>
<ul>
<li>
<p>ç›‘æ§æ‰€æœ‰æ‰§è¡Œçš„æŒ‡ä»¤</p>
</li>
<li>
<p>è®°å½•å¯„å­˜å™¨å˜åŒ–</p>
</li>
<li>
<p>åè°ƒè¯•</p>
</li>
</ul>
<p>ç¤ºä¾‹ä»£ç </p>
<pre tabindex="0"><code>from unicorn import *
from unicorn.arm64_const import *

# Hook å›è°ƒå‡½æ•°
def hook_code(mu, address, size, user_data):
    print(f&#34;Executing instruction at 0x{address:X}, size={size}&#34;)

# åˆå§‹åŒ– Unicorn ARM64
mu = Uc(UC_ARCH_ARM64, UC_MODE_ARM)

# åˆ†é…å†…å­˜
BASE = 0x1000
mu.mem_map(BASE, 0x1000)

# å†™å…¥ç®€å•çš„ ARM64 æŒ‡ä»¤
code = b&#34;\x20\x00\x80\xd2&#34;  # MOV X0, #1
mu.mem_write(BASE, code)

# æ³¨å†Œ Hook
mu.hook_add(UC_HOOK_CODE, hook_code)

# è®¾ç½® PC å¹¶æ‰§è¡Œ
mu.reg_write(UC_ARM64_REG_PC, BASE)
mu.emu_start(BASE, BASE + len(code))
</code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>Executing instruction at 0x1000, size=4
</code></pre><h1 id="hook-ä»£ç å—uc_hook_block-">Hook ä»£ç å—ï¼ˆUC_HOOK_BLOCK ï¼‰</h1>
<p>UC_HOOK_BLOCKç”¨äº Hook ä»£ç å—ï¼ˆBasic Blockï¼‰æ‰§è¡Œï¼Œåœ¨ Unicorn æ¨¡æ‹Ÿæ‰§è¡Œæ—¶ï¼Œæ¯è¿›å…¥ä¸€ä¸ªæ–°çš„ Basic Blockï¼Œéƒ½ä¼šè§¦å‘ Hook å›è°ƒã€‚</p>
<p>ç¤ºä¾‹ä»£ç </p>
<ol>
<li>
<p>æ¨¡æ‹Ÿæ‰§è¡Œ ARM64 ä»£ç </p>
</li>
<li>
<p>ä½¿ç”¨ UC_HOOK_BLOCK ç›‘å¬ä»£ç å—æ‰§è¡Œ</p>
</li>
<li>
<p>æ‰“å°æ¯ä¸ª Block çš„èµ·å§‹åœ°å€</p>
</li>
</ol>
<pre tabindex="0"><code>from unicorn import *
from unicorn.arm64_const import *

# **ARM64 æŒ‡ä»¤**
# ä»£ç å—0x1000
CODE  = b&#34;\x20\x00\x80\x52&#34;  # MOV W0, #1
CODE += b&#34;\x21\x00\x80\x52&#34;  # MOV W1, #1
CODE += b&#34;\x00\x00\x00\xB4&#34;  # CBZ W0, label
# ä»£ç å—0x100C
CODE += b&#34;\x42\x00\x80\x52&#34;  # MOV W2, #2
CODE += b&#34;\xC0\x03\x5F\xD6&#34;  # RET

# **HOOK ä»£ç å—**
def hook_block(mu, address, size, user_data):
    print(f&#34;[HOOK] è¿›å…¥ä»£ç å—: 0x{address:X} (å¤§å°: {size} å­—èŠ‚)&#34;)

# **HOOK è®¿é—®æœªæ˜ å°„å†…å­˜**
def hook_unmapped(mu, access, address, size, value, user_data):
    print(f&#34;[HOOK] è®¿é—®æœªæ˜ å°„å†…å­˜: 0x{address:X}&#34;)
    return False  # ç»ˆæ­¢æ‰§è¡Œï¼Œé¿å…å´©æºƒ

# **åˆå§‹åŒ– Unicorn**
mu = Uc(UC_ARCH_ARM64, UC_MODE_ARM)

# **æ˜ å°„å†…å­˜**
CODE_BASE = 0x1000
mu.mem_map(CODE_BASE, 0x1000)
mu.mem_write(CODE_BASE, CODE)

# **è®¾ç½®å¯„å­˜å™¨**
mu.reg_write(UC_ARM64_REG_PC, CODE_BASE)

# **æ·»åŠ  Hook**
mu.hook_add(UC_HOOK_BLOCK, hook_block)
mu.hook_add(UC_HOOK_MEM_READ_UNMAPPED | UC_HOOK_MEM_WRITE_UNMAPPED, hook_unmapped)

# **æ‰§è¡Œä»£ç **
try:
    print(&#34;[INFO] å¼€å§‹æ‰§è¡Œä»£ç ...&#34;)
    mu.emu_start(CODE_BASE, CODE_BASE + len(CODE) - 4)  # å› ä¸º RET æ˜¯æœ€åä¸€æ¡æŒ‡ä»¤ï¼Œä¸åº”æ‰§è¡Œè¶…å‡ºèŒƒå›´çš„åœ°å€ï¼Œæ‰€æœ‰ -4
    print(&#34;[INFO] æ‰§è¡Œå®Œæˆ&#34;)
except UcError as e:
    print(f&#34;[ERROR] Unicorn è¿è¡Œé”™è¯¯: {e}&#34;)
</code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>[INFO] å¼€å§‹æ‰§è¡Œä»£ç ...
[HOOK] è¿›å…¥ä»£ç å—: 0x1000 (å¤§å°: 12 å­—èŠ‚)
[HOOK] è¿›å…¥ä»£ç å—: 0x100C (å¤§å°: 4 å­—èŠ‚)
[INFO] æ‰§è¡Œå®Œæˆ
</code></pre><h1 id="hook-å†…å­˜è¯»å†™-uc_hook_mem_read--uc_hook_mem_write">Hook å†…å­˜è¯»å†™ (UC_HOOK_MEM_READ &amp; UC_HOOK_MEM_WRITE)</h1>
<p><strong>ç”¨é€”</strong> ï¼š</p>
<ul>
<li>
<p>ç›‘è§†ç‰¹å®šå˜é‡</p>
</li>
<li>
<p>åè°ƒè¯•æ£€æµ‹</p>
</li>
</ul>
<pre tabindex="0"><code>from unicorn import *
from unicorn.arm64_const import *

# å†…å­˜åŒºåŸŸ
MEMORY_BASE = 0x1000
MEMORY_SIZE = 0x1000

# ç›®æ ‡å†…å­˜åœ°å€
TARGET_ADDR = MEMORY_BASE + 0x200  # ç›®æ ‡å˜é‡å­˜å‚¨åœ°å€

# éœ€è¦æ‰§è¡Œçš„ ARM64 ä»£ç ï¼š
# MOV W0, #42    -&gt;  40 05 80 52  (æŠŠ 42 å­˜å…¥ W0)
# STR W0, [X1]   -&gt;  20 00 00 B9  (æŠŠ W0 çš„å€¼å­˜å…¥ X1 æŒ‡å‘çš„åœ°å€)
# LDR W2, [X1]   -&gt;  22 00 40 B9  (ä» X1 æŒ‡å‘çš„åœ°å€åŠ è½½å€¼åˆ° W2)
# BR X30         -&gt;  C0 03 5F D6  (è¿”å›)

CODE = b&#34;\x40\x05\x80\x52&#34;  # MOV W0, #42
CODE += b&#34;\x20\x00\x00\xB9&#34;  # STR W0, [X1]
CODE += b&#34;\x22\x00\x40\xB9&#34;  # LDR W2, [X1]
CODE += b&#34;\xC0\x03\x5F\xD6&#34;  # BR X30 (Return)

# ç›‘æ§å†…å­˜è¯»å–
def hook_mem_read(mu, access, address, size, value, user_data):
    print(f&#34;[MEM_READ] Address: 0x{address:X}, Size: {size}&#34;)

# ç›‘æ§å†…å­˜å†™å…¥
def hook_mem_write(mu, access, address, size, value, user_data):
    print(f&#34;[MEM_WRITE] Address: 0x{address:X}, Size: {size}, Value: 0x{value:X}&#34;)

# åˆå§‹åŒ– Unicorn ARM64
mu = Uc(UC_ARCH_ARM64, UC_MODE_ARM)

# åˆ†é…å†…å­˜
mu.mem_map(MEMORY_BASE, MEMORY_SIZE)

# å†™å…¥ä»£ç åˆ°å†…å­˜
mu.mem_write(MEMORY_BASE, CODE)

# åˆ†é…æ•°æ®å†…å­˜å¹¶åˆå§‹åŒ–
mu.mem_write(TARGET_ADDR, b&#34;\x00\x00\x00\x00&#34;)  # ç›®æ ‡åœ°å€åˆå§‹åŒ–ä¸º 0

# æ³¨å†Œ Hook
mu.hook_add(UC_HOOK_MEM_READ, hook_mem_read)
mu.hook_add(UC_HOOK_MEM_WRITE, hook_mem_write)

# è®¾ç½®å¯„å­˜å™¨
mu.reg_write(UC_ARM64_REG_X1, TARGET_ADDR)  # X1 æŒ‡å‘ç›®æ ‡å†…å­˜
mu.reg_write(UC_ARM64_REG_X30, MEMORY_BASE + len(CODE))  # è®¾ç½®è¿”å›åœ°å€

# å¯åŠ¨ä»¿çœŸ
mu.emu_start(MEMORY_BASE, MEMORY_BASE + len(CODE))

# è¯»å–ç»“æœ
result = mu.reg_read(UC_ARM64_REG_W2)
print(f&#34;\n[RESULT] W2 = {result}&#34;)
</code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>[MEM_WRITE] Address: 0x1200, Size: 4, Value: 0x2A
[MEM_READ] Address: 0x1200, Size: 4

[RESULT] W2 = 42
</code></pre><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒUC_HOOK_MEM_READ å’Œ UC_HOOK_MEM_WRITE ä¼šç›‘å¬æ‰€æœ‰å†…å­˜åœ°å€çš„è¯»å†™ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥æŒ‡å®šç‰¹å®šçš„å†…å­˜èŒƒå›´æ¥é™åˆ¶ Hook çš„è§¦å‘èŒƒå›´ã€‚</p>
<p>ä½ å¯ä»¥ä¼ å…¥ begin å’Œ end åœ°å€å‚æ•°ï¼Œè®© Hook åªä½œç”¨äºç‰¹å®šåŒºåŸŸï¼š</p>
<pre tabindex="0"><code>mu.hook_add(UC_HOOK_MEM_READ, hook_mem_read, begin=0x1000, end=0x2000)
mu.hook_add(UC_HOOK_MEM_WRITE, hook_mem_write, begin=0x1000, end=0x2000)
</code></pre><p>åªç›‘å¬ 0x1000 åˆ° 0x2000 ä¹‹é—´çš„å†…å­˜è®¿é—®ã€‚</p>
<h1 id="hook-æœªæ˜ å°„å†…å­˜-uc_hook_mem_read_unmapped">Hook æœªæ˜ å°„å†…å­˜ (UC_HOOK_MEM_READ_UNMAPPED)</h1>
<p><strong>ç”¨é€”</strong> ï¼š</p>
<ul>
<li>
<p>æ•è·éæ³•å†…å­˜è®¿é—®</p>
</li>
<li>
<p>ç›‘æµ‹ç¨‹åºå´©æºƒ</p>
</li>
</ul>
<pre tabindex="0"><code>from unicorn import *
from unicorn.arm64_const import *

# **ç¤ºä¾‹: è®¿é—®æœªæ˜ å°„å†…å­˜**
UNMAPPED_ADDR = 0x2000  # è¿™é‡Œçš„åœ°å€æ²¡æœ‰ mem_map

# ARM64 ä»£ç : è¯»å– `UNMAPPED_ADDR`
CODE = b&#34;\x22\x00\x40\xB9&#34;  # LDR W2, [X1]
CODE += b&#34;\xC0\x03\x5F\xD6&#34;  # BR X30


# **Hook å¤„ç†å‡½æ•°**
def hook_mem_read_unmapped(mu, access, address, size, value, user_data):
    print(f&#34;[HOOK] æœªæ˜ å°„å†…å­˜è¯»å–: Address=0x{address:X}, Size={size}&#34;)
    return False  # è¿”å› False è®© Unicorn æŠ›å‡ºå¼‚å¸¸ (æˆ–è€…è¿”å› True ç»§ç»­æ‰§è¡Œ)


# åˆå§‹åŒ– Unicorn
mu = Uc(UC_ARCH_ARM64, UC_MODE_ARM)

# ä»…æ˜ å°„ä»£ç åŒº, **ä¸æ˜ å°„ UNMAPPED_ADDR**
mu.mem_map(0x1000, 0x1000)
mu.mem_write(0x1000, CODE)

# Hook æœªæ˜ å°„å†…å­˜çš„è¯»å–
mu.hook_add(UC_HOOK_MEM_READ_UNMAPPED, hook_mem_read_unmapped)

# è®¾ç½®å¯„å­˜å™¨
mu.reg_write(UC_ARM64_REG_X1, UNMAPPED_ADDR)  # X1 = æœªæ˜ å°„åœ°å€
mu.reg_write(UC_ARM64_REG_X30, 0x1000 + len(CODE))  # è¿”å›åœ°å€

# **è¿è¡Œ Unicorn**
try:
    mu.emu_start(0x1000, 0x1000 + len(CODE))
except UcError as e:
    print(f&#34;[ERROR] Unicorn è¿è¡Œé”™è¯¯: {e}&#34;)
</code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>[HOOK] æœªæ˜ å°„å†…å­˜è¯»å–: Address=0x2000, Size=4
[ERROR] Unicorn è¿è¡Œé”™è¯¯: Invalid memory read (UC_ERR_READ_UNMAPPED)
</code></pre><h1 id="hook-ç³»ç»Ÿè°ƒç”¨-uc_hook_intr">Hook ç³»ç»Ÿè°ƒç”¨ (UC_HOOK_INTR)</h1>
<p><strong>ç”¨é€”</strong> ï¼š</p>
<ul>
<li>
<p>ç›‘è§† svc #0 ç³»ç»Ÿè°ƒç”¨</p>
</li>
<li>
<p>å¤„ç† syscall</p>
</li>
</ul>
<p>å…³äºAndroidç³»ç»Ÿè°ƒç”¨å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://cyrus-studio.github.io/blog/posts/%E6%B7%B1%E5%85%A5-android-syscall-%E5%AE%9E%E7%8E%B0%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-+-ndk-%E6%B1%87%E7%BC%96%E6%9E%84%E5%BB%BA/">æ·±å…¥ Android syscall å®ç°ï¼šå†…è”æ±‡ç¼–ç³»ç»Ÿè°ƒç”¨ + NDK æ±‡ç¼–æ„å»º</a></p>
<pre tabindex="0"><code>from unicorn import *
from unicorn.arm64_const import *

# **ARM64 SVC ä»£ç **
CODE = b&#34;\x01\x00\x00\xD4&#34;  # SVC #0
CODE += b&#34;\xC0\x03\x5F\xD6&#34;  # BR X30 (è¿”å›)


# **Hook å¤„ç†å‡½æ•°**
def hook_syscall(mu, intno, user_data):
    syscall_num = mu.reg_read(UC_ARM64_REG_X8)  # è¯»å–ç³»ç»Ÿè°ƒç”¨å· (X8)
    print(f&#34;[HOOK] æ•è·ç³»ç»Ÿè°ƒç”¨: X8 = {syscall_num}&#34;)

    if syscall_num == 1:  # ä¾‹å¦‚: æ¨¡æ‹Ÿ write(1, &#34;Hello&#34;, 5)
        x0 = mu.reg_read(UC_ARM64_REG_X0)  # æ–‡ä»¶æè¿°ç¬¦
        x1 = mu.reg_read(UC_ARM64_REG_X1)  # ç¼“å†²åŒºåœ°å€
        x2 = mu.reg_read(UC_ARM64_REG_X2)  # å­—èŠ‚æ•°
        data = mu.mem_read(x1, x2).decode(errors=&#34;ignore&#34;)
        print(f&#34;[æ¨¡æ‹Ÿ] write({x0}, \&#34;{data}\&#34;, {x2})&#34;)
        mu.reg_write(UC_ARM64_REG_X0, x2)  # è¿”å›å†™å…¥çš„å­—èŠ‚æ•°
    else:
        print(&#34;[ERROR] æœªçŸ¥ç³»ç»Ÿè°ƒç”¨&#34;)
        mu.reg_write(UC_ARM64_REG_X0, -1)  # è¿”å›é”™è¯¯


# **åˆå§‹åŒ– Unicorn**
mu = Uc(UC_ARCH_ARM64, UC_MODE_ARM)

# **æ˜ å°„å†…å­˜**
mu.mem_map(0x1000, 0x1000)
mu.mem_write(0x1000, CODE)

# **è®¾ç½® SVC è°ƒç”¨å‚æ•° (æ¨¡æ‹Ÿ write)**
buf_addr = 0x2000
mu.mem_map(buf_addr, 0x1000)
mu.mem_write(buf_addr, b&#34;Hello Unicorn!\x00&#34;)

mu.reg_write(UC_ARM64_REG_X8, 1)  # ç³»ç»Ÿè°ƒç”¨å· (write)
mu.reg_write(UC_ARM64_REG_X0, 1)  # æ–‡ä»¶æè¿°ç¬¦ (stdout)
mu.reg_write(UC_ARM64_REG_X1, buf_addr)  # ç¼“å†²åŒºåœ°å€
mu.reg_write(UC_ARM64_REG_X2, 14)  # å­—èŠ‚æ•°
mu.reg_write(UC_ARM64_REG_X30, 0x1000 + len(CODE))  # è¿”å›åœ°å€

# **Hook SVC æŒ‡ä»¤**
mu.hook_add(UC_HOOK_INTR, hook_syscall)

# **è¿è¡Œ Unicorn**
try:
    mu.emu_start(0x1000, 0x1000 + len(CODE))
except UcError as e:
    print(f&#34;[ERROR] Unicorn è¿è¡Œé”™è¯¯: {e}&#34;)
</code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>[HOOK] æ•è·ç³»ç»Ÿè°ƒç”¨: X8 = 1
[æ¨¡æ‹Ÿ] write(1, &#34;Hello Unicorn!&#34;, 14)
</code></pre><h1 id="hook-çš„ç§»é™¤">Hook çš„ç§»é™¤</h1>
<p>å¦‚æœä¸å†éœ€è¦ Hookï¼Œå¯ä»¥ä½¿ç”¨ mu.hook_del(hook_id) å–æ¶ˆ Hookï¼š</p>
<pre tabindex="0"><code>hook_id = mu.hook_add(UC_HOOK_CODE, hook_code)
mu.hook_del(hook_id)
</code></pre><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ä»£ç ï¼Œæ¼”ç¤ºäº†å¦‚ä½• æ·»åŠ ã€è§¦å‘ å’Œ ç§»é™¤ Hookã€‚</p>
<pre tabindex="0"><code>from unicorn import *
from unicorn.arm64_const import *

# **ARM64 æµ‹è¯•ä»£ç **
CODE = b&#34;\x01\x00\x00\xD4&#34;  # SVC #0 (è§¦å‘ç³»ç»Ÿè°ƒç”¨)
CODE += b&#34;\xC0\x03\x5F\xD6&#34;  # BR X30 (è¿”å›)


# **Hook å¤„ç†å‡½æ•°**
def hook_syscall(mu, intno, user_data):
    syscall_num = mu.reg_read(UC_ARM64_REG_X8)  # è¯»å–ç³»ç»Ÿè°ƒç”¨å· (X8)
    print(f&#34;[HOOK] æ•è·ç³»ç»Ÿè°ƒç”¨: X8 = {syscall_num}&#34;)

    if syscall_num == 1:
        print(&#34;[æ¨¡æ‹Ÿ] æ‰§è¡Œ write ç³»ç»Ÿè°ƒç”¨&#34;)
        mu.reg_write(UC_ARM64_REG_X0, 42)  # æ¨¡æ‹Ÿè¿”å›å€¼
    else:
        print(&#34;[ERROR] æœªçŸ¥ç³»ç»Ÿè°ƒç”¨&#34;)
        mu.reg_write(UC_ARM64_REG_X0, -1)  # è¿”å›é”™è¯¯


# **åˆå§‹åŒ– Unicorn**
mu = Uc(UC_ARCH_ARM64, UC_MODE_ARM)

# **æ˜ å°„å†…å­˜**
mu.mem_map(0x1000, 0x1000)
mu.mem_write(0x1000, CODE)

# **è®¾ç½® SVC è°ƒç”¨å‚æ•°**
mu.reg_write(UC_ARM64_REG_X8, 1)  # ç³»ç»Ÿè°ƒç”¨å· (write)
mu.reg_write(UC_ARM64_REG_X30, 0x1000 + len(CODE))  # è¿”å›åœ°å€

# **æ·»åŠ  Hook**
hook_id = mu.hook_add(UC_HOOK_INTR, hook_syscall)
print(f&#34;[INFO] Hook å·²æ·»åŠ , ID = {hook_id}&#34;)

# **è¿è¡Œ Unicorn**
try:
    print(&#34;[INFO] ç¬¬ä¸€æ¬¡æ‰§è¡Œ:&#34;)
    mu.emu_start(0x1000, 0x1000 + len(CODE))

    # **ç§»é™¤ Hook**
    mu.hook_del(hook_id)
    print(&#34;[INFO] Hook å·²ç§»é™¤&#34;)

    # **é‡æ–°æ‰§è¡Œ (Hook ä¸å†è§¦å‘)**
    print(&#34;[INFO] ç¬¬äºŒæ¬¡æ‰§è¡Œ:&#34;)
    mu.reg_write(UC_ARM64_REG_X8, 1)  # é‡æ–°è®¾ç½®ç³»ç»Ÿè°ƒç”¨å·
    mu.emu_start(0x1000, 0x1000 + len(CODE))

except UcError as e:
    print(f&#34;[ERROR] Unicorn è¿è¡Œé”™è¯¯: {e}&#34;)
</code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<pre tabindex="0"><code>[INFO] Hook å·²æ·»åŠ , ID = 2896374788624
[INFO] ç¬¬ä¸€æ¬¡æ‰§è¡Œ:
[HOOK] æ•è·ç³»ç»Ÿè°ƒç”¨: X8 = 1
[æ¨¡æ‹Ÿ] æ‰§è¡Œ write ç³»ç»Ÿè°ƒç”¨
[INFO] Hook å·²ç§»é™¤
[INFO] ç¬¬äºŒæ¬¡æ‰§è¡Œ:
[ERROR] Unicorn è¿è¡Œé”™è¯¯: Unhandled CPU exception (UC_ERR_EXCEPTION)
</code></pre><p>ç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶å´©æºƒï¼Œå› ä¸º SVC æŒ‡ä»¤è§¦å‘äº†ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œ Hook å·²ç§»é™¤ï¼Œæ²¡æœ‰æ¨¡æ‹Ÿè¿”å›å€¼ï¼Œå¯¼è‡´ CPU å¼‚å¸¸ (UC_ERR_EXCEPTION)ã€‚</p>

  </div>


  <div class="post-footer">

    
    

    
    <hr class="section-divider" />

    <div id="waline"></div>
    <script type="module">
      import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

      init({
        el: '#waline',
        serverURL: 'https://waline-15wtwfoa7-cyrus-studios-projects.vercel.app',
        path: location.pathname, 
        pageview: true,          
      });
    </script>
  </div>

</article>



<div id="toc" class="toc-container hidden"></div>


<button id="toc-toggle" class="toc-toggle" aria-label="ç›®å½•">
  &#9776;
</button>


<script src="/blog/js/toc.js"></script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      
      document.querySelectorAll('pre').forEach(function(block) {
          
          var button = document.createElement('button');
          button.className = 'copy-btn';
          button.textContent = 'å¤åˆ¶';

          
          block.appendChild(button);

          
          var clipboard = new ClipboardJS(button, {
              target: function() {
                  return block.querySelector('code');
              }
          });

          
          clipboard.on('success', function(e) {
              e.trigger.textContent = 'å¤åˆ¶æˆåŠŸ';
              setTimeout(function() {
                  e.trigger.textContent = 'å¤åˆ¶';
              }, 2000);
          });

          
          clipboard.on('error', function(e) {
              e.trigger.textContent = 'å¤åˆ¶å¤±è´¥';
          });
      });
  });
</script>



    </main>
  </body>
</html>
